services:
    # MongoDB service
    mongodb:
        image: mongo:latest
        restart: always
        volumes:
            - mongodb_data:/data/db
        ports:
            - "27017:27017"
        environment:
            - MONGO_INITDB_ROOT_USERNAME=${MONGO_USERNAME}
            - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
        networks:
            - app_network

    # Product Service
    product-service:
        build:
            context: ./product-service
            dockerfile: Dockerfile
        restart: always
        ports:
            - "3001:3001"
        environment:
            - NODE_ENV=production
            - MONGO_URI=mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@mongodb:27017/convertcart?authSource=admin
            - PORT=3001
            - WOO_BASE_URL=${WOO_BASE_URL}
            - WOO_CONSUMER_KEY=${WOO_CONSUMER_KEY}
            - WOO_CONSUMER_SECRET=${WOO_CONSUMER_SECRET}
        depends_on:
            - mongodb
        networks:
            - app_network

    # Segment Service
    segment-service:
        build:
            context: ./segment-service
            dockerfile: Dockerfile
        restart: always
        ports:
            - "3002:3002"
        environment:
            - NODE_ENV=production
            - PORT=3002
            - PRODUCT_SERVICE_URL=http://product-service:3001
        depends_on:
            - product-service
        networks:
            - app_network

    # Frontend Service
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        restart: always
        ports:
            - "3000:3000"
        environment:
            - NODE_ENV=production
            - NEXT_PUBLIC_PRODUCT_SERVICE_URL=http://product-service:3001
            - NEXT_PUBLIC_SEGMENT_SERVICE_URL=http://segment-service:3002
        depends_on:
            - product-service
            - segment-service
        networks:
            - app_network

networks:
    app_network:
        driver: bridge

volumes:
    mongodb_data:
        driver: local
